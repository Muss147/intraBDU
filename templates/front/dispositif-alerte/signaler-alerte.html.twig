{% extends 'front/layout.html.twig' %}

{% block title "Deposer une alerte" %}

{% block stylesheets %}
{% endblock %}

{% block body %}
<div class="max-w-screen-xl mx-auto px-4 mt-6 mb-12">
    <!-- Sujets les plus consultés -->
    {{form_start(form, {'attr': {'data-turbo': 'false', 'id': '', 'class': 'pb-8 min-h-screen space-y-16 md:space-y-10'}})}}
        <h2 class="text-primary text-xl font-semibold mb-4">Deposer une alerte</h2>

        <div class="p-4 md:px-8 rounded-lg bg-gray-100">
            <ol class="flex items-center w-full text-sm font-medium text-center text-gray-500 sm:text-base" id="default-styled-tab" data-tabs-toggle="#default-styled-tab-content" data-tabs-active-classes="text-secondary hover:text-secondary border-secondary" data-tabs-inactive-classes="text-gray-500 hover:text-gray-600 border-gray-100 hover:border-gray-300" role="tablist">
                <li class="flex md:w-full items-center text-primary sm:white-[''] after:w-full after:h-1 after:border after:border-gray-400 after:border-1 after:hidden sm:after:inline-block after:mx-6 xl:after:mx-10" role="presentation">
                    <span class="flex flex-wrap items-center justify-center after:content-['/'] sm:after:hidden after:mx-2 after:text-gray-200" id="profile-tab" data-tabs-target="#styled-profile" type="button" role="tab" aria-controls="profile" aria-selected="true">
                        <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/>
                        </svg>
                        Catégorie <span class="hidden sm:inline-flex sm:ms-2">du signalement</span>
                    </span>
                </li>
                <li class="flex md:w-full items-center after:content-[''] after:w-full after:h-1 after:border after:border-gray-400 after:border-1 after:hidden sm:after:inline-block after:mx-6 xl:after:mx-10">
                    <span class="flex flex-wrap items-center justify-center after:content-['/'] sm:after:hidden after:mx-2 after:text-gray-200" id="dashboard-styled-tab" data-tabs-target="#styled-dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="false">
                        <span class="me-2">2</span>
                        Détails <span class="hidden sm:inline-flex sm:ms-2">personnels</span>
                    </span>
                </li>
                <li class="flex items-center">
                    <span id="contacts-styled-tab" data-tabs-target="#styled-contacts" type="button" role="tab" aria-controls="contacts" aria-selected="false">
                        <span class="me-2">3</span>
                        Description <span class="hidden sm:inline-flex sm:ms-2">du signalement</span>
                    </span>
                </li>
            </ol>
        </div>

        <div id="default-styled-tab-content" class="">
            <div class="space-y-5" id="styled-profile" role="tabpanel" aria-labelledby="profile-tab">
                <h2 class="font-semibold text-lg">1. Entité et Catégorie du signalement</h2>
                <div class="p-8 md:px-16 rounded-lg bg-gray-100">
                    <label for="alertes_form_categorie" class="block mb-4 text-lg font-medium text-gray-900">Parmi les choix ci-dessous, cochez celui qui vous convient</label>
                    <div class="space-y-2">
                        {% for key, choice in form.categorie.vars.choices %}
                            {% set id = form.categorie.vars.id ~ '_' ~ loop.index0 %}
                            <div class="flex items-center ps-4 border border-gray-200 rounded-sm">
                                <input
                                    type="radio"
                                    id="{{ id }}"
                                    name="{{ form.categorie.vars.full_name }}"
                                    value="{{ choice.value }}"
                                    class="w-4 h-4 text-primary bg-white border-gray-300 focus:ring-primary focus:ring-2"
                                    {% if choice.value == form.categorie.vars.data %}checked{% endif %}
                                >
                                <label for="{{ id }}" class="w-full py-4 ms-2 text-md text-gray-900">
                                    {{ choice.label }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="hidden space-y-5" id="styled-dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <h2 class="font-semibold text-lg">2. Détails personnels</h2>
                <div class="p-8 md:px-16 rounded-lg bg-gray-100 space-y-7">
                    <div class="space-y-4">
                        <p>Le dispositif d'alerte garantit toutes les conditions de sécurité et de confidentialité.</p>

                        <p>C’est pourquoi BDU-CI vous conseille de révéler vos coordonnées : cela facilite la poursuite du traitement de votre signalement ou de votre question et la mise en œuvre de mesures de protection prévues par la loi . Vous avez cependant la possibilité de rester anonyme si vous le souhaitez.</p>

                        <p>Vous êtes informé(e) que les données collectées et enregistrées dans la plateforme de signalement sont strictement nécessaires pour traiter le signalement ou la question.</p>

                        <p>Pour en savoir plus sur le traitement de vos données à caractère personnel, cliquez ici</p>
                    </div>

                    <div class="">
                        <label for="alertes_form_categorie" class="block text-lg font-medium text-gray-900">Informations personnelles :</label>
                        <p id="helper-radio-text" class="text-sm mb-4 font-normal text-gray-500">Que votre signalement ou question soit anonyme ou pas, vous pourrez revenir consulter votre dossier sur Hello Ethics sur votre espace personnel qui est sécurisé par un numéro de référence de dossier et un mot de passe personnel.*</p>
                        <div class="flex items-center mb-3">
                            <input id="anonyme-1" type="radio" value="anonyme" name="anonyme" class="w-4 h-4 text-primary bg-white border-gray-300 focus:ring-primary focus:ring-2">
                            <label for="anonyme-1" class="ms-2 text-md text-gray-900">Je reste anonyme</label>
                        </div>
                        <div class="flex items-center">
                            <input checked id="anonyme-2" type="radio" value="none-anonyme" name="anonyme" class="w-4 h-4 text-primary bg-white border-gray-300 focus:ring-primary focus:ring-2">
                            <label for="anonyme-2" class="ms-2 text-md text-gray-900">Je communique mes coordonnées (BDU-CI est susceptible de vous contacter sur ces coordonnées en cas de besoin. Ces coordonnées sont utilisées exclusivement à des fins de traitement de votre signalement ou de votre question)</label>
                        </div>
                    </div>

                    <div class="noneAnonyme grid gap-6 mb-6 md:grid-cols-2">
                        <div>
                            <label for="alertes_form_categorie" class="block mb-2 text-sm font-medium text-gray-900">Prénoms</label>
                            {{form_widget(form.prenoms, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Exemple : Jean'}})}}
                        </div>
                        <div>
                            <label for="alertes_form_sousCategorie" class="block mb-2 text-sm font-medium text-gray-900">Nom de famille</label>
                            {{form_widget(form.nom, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Exemple : Dupont'}})}}
                        </div>
                        <div>
                            <label for="alertes_form_processus" class="block mb-2 text-sm font-medium text-gray-900">Téléphone</label>
                            {{form_widget(form.telephone, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Numéro de téléphone'}})}}
                        </div>  
                        <div>
                            <label for="alertes_form_sousProcessus" class="block mb-2 text-sm font-medium text-gray-900">Adresse email</label>
                            {{form_widget(form.email, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Adresse électronique'}})}}
                        </div>
                        <div>
                            <label for="alertes_form_montantEstime" class="block mb-2 text-sm font-medium text-gray-900">Adresse de résidence</label>
                            {{form_widget(form.adresse, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Quartier, Commune, Ville'}})}}
                        </div>
                        <div class="col-span-2 space-y-6">
                            <p>Par ailleurs, si vous avez indiqué une adresse e-mail, vous pourrez y recevoir :</p>
                            <ul>
                                <li>la référence de votre dossier</li>
                                <li>les messages relatifs à votre signalement ou votre question, à consulter dans votre espace personnel sécurisé sur ce service Hello Ethics/EQS Integrity Line.</li>
                            </ul>
                            <p>Pour cela, il vous suffit de donner votre accord ici :</p>
                            
                            <div class="flex items-center">
                                {{form_widget(form.accord, {'attr': {'class': 'w-4 h-4 text-primary bg-white border-gray-300 focus:ring-primary focus:ring-2'}})}}
                                <label for="{{ form.accord.vars.id }}" class="ms-2 text-md font-medium text-gray-900">Oui, j’accepte de recevoir sur l’adresse e-mail que j’ai indiquée ci-dessus, des messages en provenance de EQS Integrity Line Notification.</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="hidden space-y-5" id="styled-contacts" role="tabpanel" aria-labelledby="contacts-tab">
                <h2 class="font-semibold text-lg">3. Description / Chargement de(s) fichier(s)</h2>
                <div class="p-8 md:px-16 rounded-lg bg-gray-100">
                    <div class="space-y-6">
                        <p>Veuillez décrire la conduite ou la situation inappropriée avec précision et en fournissant le plus de d’éléments possible :</p>
                        <ul>
                            <li>Nommer la ou les personnes impliquées (avec si possible nom, prénom, téléphone et mail),</li>
                            <li>le lieu concerné (pays, ville, adresse),</li>
                            <li>les services impliqués (entité, filiale, entreprise, fournisseur, ...),</li>
                            <li>la date de cet événement (jour, mois, année, heure)</li>
                        </ul>
                        <p> ainsi que toute information que vous jugerez utile à la description de la conduite, la situation inappropriée, l’origine et la raison de votre signalement.</p>
                        
                        <p> Si la pertinence des informations apportées apparaît insuffisante, le responsable du suivi pourra vous demander des éléments complémentaires en l’absence desquels votre alerte pourrait être classée sans suite.</p>

                        <p> Rappel : ce site n’est pas destiné à recevoir des réclamations liées à des prestations commerciales qui ne pourront être traitées par l’équipe Hello Ethics : nous vous suggérons en revanche de vous adresser à votre service client BDU-CI.*</p>
                    </div>
                    <div class="mb-6">
                        {{form_widget(form.description, {'attr': {'rows': '10', 'class': 'block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:outline-none focus:ring-0 focus:border-primary', 'placeholder': 'Écrivez les conséquences ici...'}})}}
                    </div>

                    <div class="">
                        <label for="{{ form.salarie.vars.id }}" class="block mb-2 text-sm font-medium text-gray-900">Etes-vous salarié de la BDU-CI ?</label>
                        {% for radio in form.salarie %}
                            <div class="flex items-center mb-4">
                                {{ form_widget(radio, {
                                    'attr': {
                                        'class': 'w-4 h-4 text-primary bg-white border-gray-300 focus:ring-blue-500 focus:ring-2'
                                    }
                                }) }}
                                {# <label for="{{ radio.vars.id }}" class="ms-2 text-sm font-medium text-gray-900">
                                    {{ radio.vars.label }}
                                </label> #}
                            </div>
                        {% endfor %}
                    </div>

                    <div class="">
                        <label for="alertes_form_fichiers" class="block mb-2 text-sm font-medium text-gray-900">Charger des fichiers</label>
                        {{form_widget(form.fichiers, {'attr': {
                            'class': 'block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none', 
                            'accept': '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpeg,.jpg,.gif'
                        }})}}
                        <p class="mt-1 text-sm text-gray-500" id="file_input_help">Vous avez ici la possibilité de charger des fichiers. Les formats de fichiers suivants sont autorisés : PDF, Word, Excel, PowerPoint, GIF, JPEG.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-end gap-2 mt-4 items-center">
            <button id="prevTab" type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded text-center inline-flex items-center disabled:hidden" disabled>
                <svg class="w-6 h-6 text-gray-800" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12l4-4m-4 4 4 4"/></svg>
                Précédent
            </button>
            <button id="nextTab" type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded text-center inline-flex items-center">
                Suivant
                <svg class="rtl:rotate-180 w-3.5 h-3.5 ms-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/></svg>
            </button>
            <button id="saveTab" type="submit" class="bg-primary text-white px-4 py-2 rounded text-center inline-flex items-center">
                Enregistrer
                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11.917 9.724 16.5 19 7.5"/></svg>
            </button>
        </div>
        {# CSRF token explicitement affiché #}
        {{ form_row(form._token) }}

    {{form_end(form, { render_rest: false })}}

    <!-- Notification messages -->
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div id="flash-modal" class="fixed inset-0 flex items-center justify-center z-50 bg-black/50">
                <div class="max-w-md w-full p-4 rounded-lg shadow-lg
                    {% if label == 'success' %}
                        bg-green-50 text-green-800 border border-green-300
                    {% elseif label == 'error' %}
                        bg-red-50 text-red-800 border border-red-300
                    {% endif %}">
                    <div class="flex items-center">
                        <svg class="shrink-0 w-4 h-4 me-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
                        </svg>
                        <h3 class="text-lg font-semibold">
                            {% if label == 'success' %} Succès {% else %} Erreur {% endif %}
                        </h3>
                    </div>
                    <p class="mt-2 text-sm">{{ message|raw }}</p>
                    <div class="mt-4 flex">
                        <button onclick="closeFlashModal()" class="px-4 py-2 text-xs font-medium rounded-lg
                            {% if label == 'success' %}
                                bg-green-800 text-white hover:bg-green-900
                            {% else %}
                                bg-red-800 text-white hover:bg-red-900
                            {% endif %}">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endfor %}
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
    function closeFlashModal() {
        const modal = document.getElementById('flash-modal');
        if (modal) modal.remove();
    }

    document.addEventListener('turbo:load', function () {
        setTimeout(() => closeFlashModal(), 5000);
        
        const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
        const tabPanels = Array.from(document.querySelectorAll('[role="tabpanel"]'));
        const prevBtn = document.getElementById("prevTab");
        const nextBtn = document.getElementById("nextTab");
        const saveBtn = document.getElementById("saveTab");

        const getActiveIndex = () => tabs.findIndex(tab => tab.getAttribute("aria-selected") === "true");

        const activateTab = (index) => {
            if (index < 0 || index >= tabs.length) return;
            tabs[index].click();
            updateButtons(index);
        };

        const updateButtons = (index = getActiveIndex()) => {
            prevBtn.disabled = index === 0;
            nextBtn.classList.toggle("hidden", index === tabs.length - 1);
            saveBtn.classList.toggle("hidden", index !== tabs.length - 1);
        };

        const validateActiveTab = () => {
            const index = getActiveIndex();
            const currentPanel = tabPanels[index];
            const requiredFields = currentPanel.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('border-red-500', 'ring-red-300');
                } else {
                    field.classList.remove('border-red-500', 'ring-red-300');
                }
            });

            if (!isValid) {
                alert("Veuillez remplir tous les champs obligatoires avant de continuer.");
            }

            return isValid;
        };

        prevBtn.addEventListener("click", () => {
            activateTab(getActiveIndex() - 1);
        });

        nextBtn.addEventListener("click", () => {
            if (validateActiveTab()) {
                activateTab(getActiveIndex() + 1);
            }
        });

        // Initialisation
        activateTab(0);

        document.querySelectorAll('input[name="anonyme"]').forEach((input) => {
            input.addEventListener('change', (e) => {
                const noneAnonyme = document.querySelector('div.noneAnonyme');
                if (e.target.value === 'anonyme') {
                    noneAnonyme.classList.add('hidden');
                } else {
                    noneAnonyme.classList.remove('hidden');
                }
            });
        });
        // Gère l'état initial
        const selected = document.querySelector('input[name="anonyme"]:checked');
        const noneAnonyme = document.querySelector('div.noneAnonyme');
        if (selected && selected.value === 'anonyme') {
            noneAnonyme.classList.add('hidden');
        }
    });
</script>
{% endblock %}