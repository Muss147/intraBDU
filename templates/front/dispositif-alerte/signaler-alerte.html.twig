{% extends 'front/layout.html.twig' %}

{% block title "Deposer une alerte" %}

{% block stylesheets %}
{% endblock %}

{% block body %}
<div class="max-w-screen-xl mx-auto px-4 mt-6 mb-12">
    <!-- Sujets les plus consultés -->
    {{form_start(form, {'attr': {'id': '', 'class': 'pb-8 min-h-screen space-y-16 md:space-y-10'}})}}
        <h2 class="text-primary text-xl font-semibold mb-4">Deposer une alerte</h2>

        <div class="p-4 md:px-8 rounded-lg bg-gray-100">
            <ol class="flex items-center w-full text-sm font-medium text-center text-gray-500 sm:text-base" id="default-styled-tab" data-tabs-toggle="#default-styled-tab-content" data-tabs-active-classes="text-secondary hover:text-secondary border-secondary" data-tabs-inactive-classes="dark:border-transparent text-gray-500 hover:text-gray-600 border-gray-100 hover:border-gray-300" role="tablist">
                <li class="flex md:w-full items-center text-blue-600 sm:after:content-[''] after:w-full after:h-1 after:border after:border-gray-400 after:border-1 after:hidden sm:after:inline-block after:mx-6 xl:after:mx-10" role="presentation">
                    <span class="flex flex-wrap items-center justify-center after:content-['/'] sm:after:hidden after:mx-2 after:text-gray-200" id="profile-tab" data-tabs-target="#styled-profile" type="button" role="tab" aria-controls="profile" aria-selected="true">
                        <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/>
                        </svg>
                        Catégorie <span class="hidden sm:inline-flex sm:ms-2">du signalement</span>
                    </span>
                </li>
                <li class="flex md:w-full items-center after:content-[''] after:w-full after:h-1 after:border after:border-gray-400 after:border-1 after:hidden sm:after:inline-block after:mx-6 xl:after:mx-10">
                    <span class="flex flex-wrap items-center justify-center after:content-['/'] sm:after:hidden after:mx-2 after:text-gray-200" id="dashboard-styled-tab" data-tabs-target="#styled-dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="false">
                        <span class="me-2">2</span>
                        Détails <span class="hidden sm:inline-flex sm:ms-2">personnels</span>
                    </span>
                </li>
                <li class="flex items-center">
                    <span id="contacts-styled-tab" data-tabs-target="#styled-contacts" type="button" role="tab" aria-controls="contacts" aria-selected="false">
                        <span class="me-2">3</span>
                        Description <span class="hidden sm:inline-flex sm:ms-2">du signalement</span>
                    </span>
                </li>
            </ol>
        </div>

        <div id="default-styled-tab-content" class="">
            <div class="space-y-5" id="styled-profile" role="tabpanel" aria-labelledby="profile-tab">
                <h2 class="font-semibold text-lg">1. Entité et Catégorie du signalement</h2>
                <div class="p-8 md:px-16 rounded-lg bg-gray-100">
                    <div class="grid gap-6 mb-6 md:grid-cols-2">
                        <div>
                            <label for="alertes_form_categorie" class="block mb-2 text-sm font-medium text-gray-900">Parmi les choix ci-dessous, cochez celui qui vous convient</label>
                            <div class="grid md:grid-cols-3 gap-2">
                                {% for radio in form.categorie %}
                                <div class="flex items-center ps-4 border border-gray-300 bg-gray-50 rounded-md py-2">
                                    {{ form_widget(radio, {
                                        attr: {
                                            class: 'w-4 h-4 me-3 text-blue-600 bg-gray-200 border-gray-600 focus:ring-blue-500 focus:ring-2'
                                        }
                                    }) }}
                                    {{ form_label(radio, null, {
                                        label_attr: {
                                            class: 'w-full py-3 ms-2 text-sm font-medium text-gray-900'
                                        }
                                    }) }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="hidden space-y-5" id="styled-dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <h2 class="font-semibold text-lg">2. Détails personnels</h2>
                <div class="p-8 md:px-16 rounded-lg bg-gray-100">
                    <p>Le dispositif d'alerte garantit toutes les conditions de sécurité et de confidentialité.</p>

                    <p>C’est pourquoi Orange vous conseille de révéler vos coordonnées : cela facilite la poursuite du traitement de votre signalement ou de votre question et la mise en œuvre de mesures de protection prévues par la loi . Vous avez cependant la possibilité de rester anonyme si vous le souhaitez.</p>

                    <p>Vous êtes informé(e) que les données collectées et enregistrées dans la plateforme de signalement sont strictement nécessaires pour traiter le signalement ou la question.</p>

                    <p>Pour en savoir plus sur le traitement de vos données à caractère personnel, cliquez ici
                    Informations personnelles :<br>
                    Que votre signalement ou question soit anonyme ou pas, vous pourrez revenir consulter votre dossier sur Hello Ethics sur votre espace personnel qui est sécurisé par un numéro de référence de dossier et un mot de passe personnel.*</p>

                    <div class="grid gap-6 mb-6 md:grid-cols-2">
                        <div>
                            <label for="incidents_form_categorie" class="block mb-2 text-sm font-medium text-gray-900">Catégorisation baloise de risques</label>
                            {{form_widget(form.categorie, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Sélectionner une catégorie'}})}}
                        </div>
                        <div>
                            <label for="incidents_form_sousCategorie" class="block mb-2 text-sm font-medium text-gray-900">Sous-catégorie d'incidents</label>
                            {{form_widget(form.sousCategorie, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Sélectionner une sous catégorie'}})}}
                        </div>
                        <div>
                            <label for="incidents_form_processus" class="block mb-2 text-sm font-medium text-gray-900">Processus</label>
                            {{form_widget(form.processus, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Sélectionner un processus'}})}}
                        </div>  
                        <div>
                            <label for="incidents_form_sousProcessus" class="block mb-2 text-sm font-medium text-gray-900">Sous processus</label>
                            {{form_widget(form.sousProcessus, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Sélectionner un sous processus'}})}}
                        </div>
                        <div>
                            <label for="incidents_form_montantEstime" class="block mb-2 text-sm font-medium text-gray-900">Montant estimé de la perte (TTC/HT)</label>
                            {{form_widget(form.montantEstime, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': ''}})}}
                        </div>  
                        <div>
                            <label for="incidents_form_datePerte" class="block mb-2 text-sm font-medium text-gray-900">Date de comptabilisation de la perte</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"/>
                                    </svg>
                                </div>
                                {{form_widget(form.datePerte)}}
                            </div>
                        </div>
                        <div>
                            <label for="incidents_form_directionImpacte" class="block mb-2 text-sm font-medium text-gray-900">Direction / Département / Service impacté</label>
                            {{form_widget(form.directionImpacte, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': 'Sélectionner une direction'}})}}
                        </div>
                        <div>
                            <label for="incidents_form_montantObtenu" class="block mb-2 text-sm font-medium text-gray-900">Montant des récupérations obtenues (TTC/HT)</label>
                            {{form_widget(form.montantObtenu, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': ''}})}}
                        </div>  
                        <div>
                            <label for="incidents_form_dateRecup" class="block mb-2 text-sm font-medium text-gray-900">Date de la récupération</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"/>
                                    </svg>
                                </div>
                                {{form_widget(form.dateRecup)}}
                            </div>
                        </div>
                        <div>
                            <label for="incidents_form_dateCompta" class="block mb-2 text-sm font-medium text-gray-900">Date de comptabilisation du montant récupéré</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"/>
                                    </svg>
                                </div>
                                {{form_widget(form.dateCompta)}}
                            </div>
                        </div> 
                        <div>
                            <label for="incidents_form_natureRecup" class="block mb-2 text-sm font-medium text-gray-900">Nature de la récupération</label>
                            {{form_widget(form.natureRecup, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': ''}})}}
                        </div>
                        <div>
                            <label for="incidents_form_montantNet" class="block mb-2 text-sm font-medium text-gray-900">Montant net de la perte</label>
                            {{form_widget(form.montantNet, {'attr': {'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:outline-none focus:ring-0 focus:border-primary block w-full p-2.5', 'placeholder': ''}})}}
                        </div>
                    </div>
                </div>
            </div>
            <div class="hidden space-y-5" id="styled-contacts" role="tabpanel" aria-labelledby="contacts-tab">
                <h2 class="font-semibold text-lg">3. Conséquences de l'incident</h2>
                <div class="p-8 md:px-16 rounded-lg bg-gray-100">
                    <div class="mb-6">
                        <label for="incidents_form_consequences" class="block mb-2 text-sm font-medium text-gray-900">Conséquences</label>
                        {{form_widget(form.consequences, {'attr': {'rows': '10', 'class': 'block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:outline-none focus:ring-0 focus:border-primary', 'placeholder': 'Écrivez les conséquences ici...'}})}}
                    </div> 
                    
                    <div class="relative overflow-x-auto mb-8" id="solutions-table">
                        <label class="block mb-2 text-sm font-medium text-gray-900">Proposition de solutions</label>

                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-transparent">
                                <tr>
                                    <th class="px-6 py-3 border border-gray-300">Actions correctives proposées</th>
                                    <th class="px-6 py-3 border border-gray-300">Responsable</th>
                                    <th class="px-6 py-3 border border-gray-300">Délai</th>
                                    <th class="px-6 py-3 border border-gray-300 text-center">Supprimer</th>
                                </tr>
                            </thead>
                            <tbody data-prototype="{{ form_widget(form.solutions.vars.prototype)|e('html_attr') }}" id="solutions-list">
                                {% for solutionForm in form.solutions %}
                                    <tr>
                                        <td class="border border-gray-300">{{ form_widget(solutionForm.action, { attr: { class: 'border-0 bg-none bg-transparent h-full w-full px-6 py-3 focus:outline-none focus:ring-0' } }) }}</td>
                                        <td class="border border-gray-300">{{ form_widget(solutionForm.responsable, { attr: { class: 'border-0 bg-none bg-transparent h-full w-full px-6 py-3 focus:outline-none focus:ring-0' } }) }}</td>
                                        <td class="border border-gray-300">{{ form_widget(solutionForm.delai, { attr: { class: 'border-0 bg-none bg-transparent h-full w-full px-6 py-3 focus:outline-none focus:ring-0' } }) }}</td>
                                        <td class="border border-gray-300 text-center">
                                            <button type="button" class="text-red-600 font-bold remove-solution">
                                                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/></svg>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <button type="button" class="mt-4 px-4 py-2 bg-primary text-white rounded hover:bg-blue-700" id="add-solution">Ajouter une ligne</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-end gap-2 mt-4 items-center">
            <button id="prevTab" type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded text-center inline-flex items-center disabled:hidden" disabled>
                <svg class="w-6 h-6 text-gray-800" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12l4-4m-4 4 4 4"/></svg>
                Précédent
            </button>
            <button id="nextTab" type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded text-center inline-flex items-center">
                Suivant
                <svg class="rtl:rotate-180 w-3.5 h-3.5 ms-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/></svg>
            </button>
            <button id="saveTab" type="submit" class="bg-primary text-white px-4 py-2 rounded text-center inline-flex items-center">
                Enregistrer
                <svg class="w-6 h-6 text-gray-800" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11.917 9.724 16.5 19 7.5"/></svg>
            </button>
        </div>
    {{form_end(form)}}

    <!-- Notification messages -->
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div id="flash-modal" class="fixed inset-0 flex items-center justify-center z-50 bg-black/50">
                <div class="max-w-md w-full p-4 rounded-lg shadow-lg
                    {% if label == 'success' %}
                        bg-green-50 text-green-800 border border-green-300
                    {% elseif label == 'error' %}
                        bg-red-50 text-red-800 border border-red-300
                    {% endif %}">
                    <div class="flex items-center">
                        <svg class="shrink-0 w-4 h-4 me-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
                        </svg>
                        <h3 class="text-lg font-semibold">
                            {% if label == 'success' %} Succès {% else %} Erreur {% endif %}
                        </h3>
                    </div>
                    <p class="mt-2 text-sm">{{ message|raw }}</p>
                    <div class="mt-4 flex">
                        <button onclick="closeFlashModal()" class="px-4 py-2 text-xs font-medium rounded-lg
                            {% if label == 'success' %}
                                bg-green-800 text-white hover:bg-green-900
                            {% else %}
                                bg-red-800 text-white hover:bg-red-900
                            {% endif %}">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endfor %}
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
    function closeFlashModal() {
        const modal = document.getElementById('flash-modal');
        if (modal) modal.remove();
    }

    document.addEventListener('turbo:load', function () {
        setTimeout(() => closeFlashModal(), 5000);
        
        const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
        const tabPanels = Array.from(document.querySelectorAll('[role="tabpanel"]'));
        const prevBtn = document.getElementById("prevTab");
        const nextBtn = document.getElementById("nextTab");
        const saveBtn = document.getElementById("saveTab");

        const getActiveIndex = () => tabs.findIndex(tab => tab.getAttribute("aria-selected") === "true");

        const activateTab = (index) => {
            if (index < 0 || index >= tabs.length) return;
            tabs[index].click();
            updateButtons(index);
        };

        const updateButtons = (index = getActiveIndex()) => {
            prevBtn.disabled = index === 0;
            nextBtn.classList.toggle("hidden", index === tabs.length - 1);
            saveBtn.classList.toggle("hidden", index !== tabs.length - 1);
        };

        const validateActiveTab = () => {
            const index = getActiveIndex();
            const currentPanel = tabPanels[index];
            const requiredFields = currentPanel.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('border-red-500', 'ring-red-300');
                } else {
                    field.classList.remove('border-red-500', 'ring-red-300');
                }
            });

            if (!isValid) {
                alert("Veuillez remplir tous les champs obligatoires avant de continuer.");
            }

            return isValid;
        };

        prevBtn.addEventListener("click", () => {
            activateTab(getActiveIndex() - 1);
        });

        nextBtn.addEventListener("click", () => {
            if (validateActiveTab()) {
                activateTab(getActiveIndex() + 1);
            }
        });

        // Initialisation
        activateTab(0);

        let tableBody = document.getElementById('solutions-list');
        let addBtn = document.getElementById('add-solution');
        let index = tableBody.children.length;

        const prototype = tableBody.dataset.prototype;

        function addSolutionRow() {
            const newRow = document.createElement('tr');
            const prototypeHtml = prototype.replace(/__name__/g, index).replace(/class="mb-3"/g, '').replace(/\s?mb-3/g, '');
            newRow.className = 'bg-transparent border-b border-gray-200';

            const template = document.createElement('tbody');
            template.innerHTML = prototypeHtml;

            const actionInput = template.querySelector('input[name$="[action]"]');
            const responsableInput = template.querySelector('input[name$="[responsable]"]');
            const delaiInput = template.querySelector('input[name$="[delai]"]');

            const td1 = document.createElement('td');
            td1.className = 'border border-gray-300';
            if (actionInput) td1.appendChild(actionInput);

            const td2 = document.createElement('td');
            td2.className = 'border border-gray-300';
            if (responsableInput) td2.appendChild(responsableInput);

            const td3 = document.createElement('td');
            td3.className = 'border border-gray-300';
            if (delaiInput) td3.appendChild(delaiInput);

            const td4 = document.createElement('td');
            td4.className = 'border border-gray-300 text-center';
            td4.innerHTML = `<button type="button" class="text-red-600 font-bold remove-solution">
                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/></svg>
            </button>`;

            newRow.appendChild(td1);
            newRow.appendChild(td2);
            newRow.appendChild(td3);
            newRow.appendChild(td4);

            tableBody.appendChild(newRow);
            index++;
        }

        // Ajouter une ligne
        addBtn.addEventListener('click', addSolutionRow);

        // Supprimer une ligne
        tableBody.addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-solution')) {
                e.target.closest('tr').remove();
            }
        });
    });
</script>
{% endblock %}